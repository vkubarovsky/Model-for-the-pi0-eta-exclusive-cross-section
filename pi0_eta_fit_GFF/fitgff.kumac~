MACRO FITGFF  DAT=pi0 SYST=yes
*
*================================================================*
*
CALL dvmpx_paw.f
IF [DAT]=pi0 THEN
   CALL XSINIT(0.135)
ELSE
   CALL XSINIT(0.540)
ENDIF
   

SET HCOL 1
VE/DEL *; HI/DEL 0
OPT LINY
OPT NSTA
OPT NGRID
OPT NDAT
OPT NBOX

EXEC HDELET  1234
VE/CREATE ZZ(100) R
VE/CREATE PAR(10) R
VE/CREATE SPAR(10)
VE/CREATE P(10) R
VE/CREATE DIM1(1) I
VE/CREATE DIM2(1) I

VE/CREATE XBI(18) R 
VE/CREATE Q2I(18) R



IF [DAT]='pi0' THEN
*
****       PI0
*

* Number of tbins in [Q2,xB] matrix  
  VE/CREATE TBINS(18) I 7 8 8 8 8 4 7 8 7  5  7  4  2  5  1  4  2  1
* Kinematics with number of points >=3
  VE/CREATE BINS3(13) I 1 2 3 4 5 6   8 9 10 11 12    14    16  


  VE/CREATE AMAS(1) R 0.135
  VE/CREATE MAXIND(1) I 1867 
  VE/READ q2,xb,tt,st,sst,s2st,slt,sslt,s2lt,stt,sstt,s2tt pi0_sf.dat
*  SIGMA SST=SQRT(SST**2+S2ST**2)
*  SIGMA SSTT=SQRT(SSTT**2+S2TT**2)


  VE/INPUT P 6.9704    1.5347   -0.9824    1.5037    0.0000   49.3140    1.8650   -0.2715    1.1129    0.0000

  VE/CREATE AMAS(1) R 0.135
  NP=$VDIM(Q2)
  NP1=[NP]
  NP2=$EVAL([NP]+1)
  NP3=$EVAL(2*[NP])
  VE/INPUT DIM1(1) [np]
  VE/INPUT DIM2(1) [np2]

ELSE

*
****       ETA
*
* Number of tbins in [Q2,xB] matrix
  VE/CREATE TBINS(17) I 7 7 5 7 5 1 2 6 6  4  5  4  4 1 1  3 1
* Kinematics with number of points >=3
  VE/CREATE BINS3(12)   I 1 2 3 4 5     8 9 10 11 12 13     16 

VE/CREATE AMAS(1)   R 0.540
VE/CREATE MAXIND(1) I 1245 
VE/READ q2,xb,tt,st,sst,s2st,slt,sslt,s2lt,stt,sstt,s2tt eta_sf.dat

VE/INPUT P 5.8071    1.6124   -1.1327    1.2305    0.0000   24.6841    1.4356   -0.1834    0.8750    0.0000


  VE/CREATE AMAS(1) R 0.540
  NP=$VDIM(Q2)
  NP1=[NP]
  NP2=$EVAL([NP]+1)
  NP3=$EVAL(2*[NP])
  VE/INPUT DIM1(1) [np]
  VE/INPUT DIM2(1) [np2]
ENDIF

* Systematic errors

IF [SYST]='yes' THEN
  SIGMA SST=SQRT(SST**2+S2ST**2)
  SIGMA SSTT=SQRT(SSTT**2+S2TT**2)
  MES SYSTEMATICS is INCLUDED
ENDIF

*-------------    Groups of bins in (Q2,xB]

NTBINS=$VDIM(TBINS)
NTBINS3=$VDIM(BINS3)

VE/CREATE ITMIN([NTBINS]) I
VE/CREATE ITMAX([NTBINS]) I

VE/CREATE  ETSLOP([NTBINS]) R
VE/CREATE SETSLOP([NTBINS]) R

VE/CREATE  HTSLOP([NTBINS]) R
VE/CREATE SHTSLOP([NTBINS]) R

VE/CREATE  ETNORM([NTBINS]) R
VE/CREATE SETNORM([NTBINS]) R

VE/CREATE  HTNORM([NTBINS]) R
VE/CREATE SHTNORM([NTBINS]) R


IMIN=1
DO I=1,[NTBINS]
  IMAX=$EVAL([IMIN]+TBINS([I])-1)
  Ve/INP ITMIN([I]) [IMIN]
  Ve/INP ITMAX([I]) [IMAX]
*  mess [i] [imin]-[imax] $EVAL(TBINS([I]))
  VE/INP Q2I([I]) Q2([IMIN])
  VE/INP XBI([I]) XB([IMIN])
  IMIN=$EVAL([IMAX]+1)
ENDDO


VE/CREATE _Q2([NP3]) R; VE/COPY Q2(1:[NP]) _Q2(1:[NP]);  VE/COPY Q2(1:[NP]) _Q2([NP2]:[NP3]); 
VE/CREATE _XB([NP3]) R; VE/COPY XB(1:[NP]) _XB(1:[NP]);  VE/COPY XB(1:[NP]) _XB([NP2]:[NP3]); 
VE/CREATE _TT([NP3]) R; VE/COPY TT(1:[NP]) _TT(1:[NP]);  VE/COPY TT(1:[NP]) _TT([NP2]:[NP3]); 

VE/CREATE   _ST([NP3]) R; VE/COPY ST(1:[NP])    _ST(1:[NP]);  VE/COPY  STT(1:[NP]) _ST([NP2]:[NP3]); 
VE/CREATE _SSTT([NP3]) R; VE/COPY SST(1:[NP]) _SSTT(1:[NP]);  VE/COPY SSTT(1:[NP]) _SSTT([NP2]:[NP3]); 

SIGMA SUMXS=ST+STT
SIGMA SSUMXS=SQRT(SST**2+SSTT**2)

1DHIST 10001 'HT+ET'  [NP1] 0.5 $EVAL([NP1]+0.5); PUT_VEC/CON 10001 ST;     PUT_VEC/ERROR 10001 SST
1DHIST 10002 'ET'     [NP1] 0.5 $EVAL([NP1]+0.5); PUT_VEC/CON 10002 STT;    PUT_VEC/ERROR 10002 SST
1DHIST 10003 'HT'     [NP1] 0.5 $EVAL([NP1]+0.5); PUT_VEC/CON 10003 SUMXS;  PUT_VEC/ERROR 10003 SSUMXS


VE/CREATE SF(1) I 2


VE/CREATE _ET2([NP])
VE/CREATE _HT2([NP])
VE/CREATE _SET2([NP])
VE/CREATE _SHT2([NP])
VE/CREATE _KET2([NP])
VE/CREATE _KHT2([NP])
DO I=1,[NP]
   Q2_=_Q2([I])
   XB_=_XB([I])
   TT_=-_TT([I])
   
   FET='ET2('//[TT_]//','//[XB_]//','//[Q2_]//')'
   FHT='HT2('//[TT_]//','//[XB_]//','//[Q2_]//')'


   FF=$CALL([FET])
   VE/INP _KET2([I]) [FF]
   VE/INP _ET2([I])  $EVAL(STT([I])*_KET2([I]))
   VE/INP _SET2([I]) $EVAL(SSTT([I])*_KET2([I])*(-1.0))
*MESS FET=[FET]
*MESS FHT=[FHT]
*MESS FF= [FF] $CALL([FET])
*MESS

*   IF _ET2([I]).LE.0. THEN
*        VE/INP _ET2([I]) 0.
*   ENDIF

   FF=$CALL([FHT])
   VE/INP _KHT2([I]) [FF]
   VE/INP _HT2([I])  $EVAL((ST([I])+STT([I]))*_KHT2([I]))
   SGM=$SIGMA(SQRT(SST([I])**2+SSTT([I])**2))
   VE/INP _SHT2([I]) $EVAL([SGM]*_KHT2([I]))
*   IF _HT2([I]).LE.0. THEN;  VE/INP _HT2([I]) 0.; ENDIF
*MESS FF=[FF] $CALL([FHT])
*WAIT    
ENDDO

*WAIT
VE/CREATE PSLOP(2) R 1 1 

****** FUNCTIONS
Application COMIS Quit
      REAL FUNCTION FITPHI(X)
      COMMON /PAWPAR/ P(10)
      FITPHI=P(1)+P(2)*COS(2*X)
      RETURN
      END

      REAL FUNCTION FITPHI3(X)
      COMMON /PAWPAR/ P(10)
      FITPHI3=P(1)+P(2)*COS(2*X)+p(3)*2*cos(X)
      RETURN
      END

      FUNCTION EXP2(X)
      COMMON /PAWPAR/ P(10)
      EXP2=P(1)*EXP(-P(2)*X)
      RETURN
      END

      FUNCTION Q2N(X)
      COMMON /PAWPAR/ P(10)
      Q2N=P(1)*X**(P(2)/2)
      RETURN
      END

      FUNCTION SLOPX(X)
      COMMON /PAWPAR/ P(10)
      SLOPX=(P(1)-P(2)*ALOG(x))*2.
      RETURN
      END

      SUBROUTINE GETFITPAR
* NPFITS  Number of points used in the fit
* NFPAR   Number of free parameters
* FITCHI  Chisquare
* FITPAR  Values of parameters
* FITSIG  Errors on parameters
       COMMON/HCFITS/NCFITS,NPFITS,NFPAR,FITCHI,FITPAR(35),FITSIG(35)
     +             ,FITDER(35)
       VECTOR PAR(35)
       VECTOR SPAR(35)
       DO I=1,10
         PAR(I)=FITPAR(I)
         SPAR(I)=FITSIG(I)
       ENDDO
       END
Quit

******************** SIGMA_T and SIGMA_TT

TITLE [DAT]//' '//[s]?T!//' and '//[s]?TT
IF [DAT]='pi0' THEN; ZONE 4 4 ; ELSE; ZONE 3 4; ENDIF
 DO J=1,[NTBINS3]
  I=$EVAL(BINS3([J]))
 IF [DAT]='pi0' THEN; NULL 0 2 -400 400 ; ELSE; NULL 0 2 -150 250; ENDIF
 I1=$EVAL(ITMIN([I])); I2=$EVAL(ITMAX([I]))
 SET PMCI 4; SET FCOL 4
 HPLOT/ERR TT([I1]:[I2])  ST([I1]:[I2])  ZZ SST([I1]:[I2]) $EVAL(TBINS([I])) 20 0.1
 HLINE 0
 SET PMCI 2; SET FCOL 2
 HPLOT/ERR TT([I1]:[I2])  STT([I1]:[I2])  ZZ SSTT([I1]:[I2]) $EVAL(TBINS([I])) 20 0.1
ENDDO
wait




******************** HT and ETbar
exe open_ps [dat]_slope_HT_ET.ps
VE/CRE EPAR(2) R 1 1
OPT LOGY; OPT NSTA; set FIT 0
ZONE 3 4
TITLE [DAT]//' HT2 '//' and '//'ETbar2'
*IF [DAT]='pi0' THEN; ZONE 4 4 ; ELSE; ZONE 3 4; ENDIF

DO J=1,[NTBINS3]-1
   I=$EVAL(BINS3([J]))
   IF [DAT]='pi0' THEN; NULL 0 2 2 20000 ; ELSE; NULL 0 2 -150 250; ENDIF
   I1=$EVAL(ITMIN([I])); I2=$EVAL(ITMAX([I]))
   SET PMCI 4; SET FCOL 4
   HPLOT/ERR  TT([I1]:[I2])  _ET2([I1]:[I2])  ZZ _SET2([I1]:[I2]) $EVAL(TBINS([I])) 20 0.1
   VECTOR/FIT TT([I1]:[I2])  _ET2([I1]:[I2])     _SET2([I1]:[I2]) EXP2 S 2 EPAR
   CALL GETFITPAR
   VE/INP  ETSLOP([I])  $EVAL(PAR(2)) 
   VE/INP  ETNORM([I])  $EVAL(PAR(1)) 
   VE/INP SETSLOP([I]) $EVAL(SPAR(2)) 
   VE/INP SETNORM([I]) $EVAL(SPAR(1)) 

    SET PMCI 2; SET FCOL 2
    HPLOT/ERR  TT([I1]:[I2])  _HT2([I1]:[I2])  ZZ _SHT2([I1]:[I2]) $EVAL(TBINS([I])) 20 0.1
    VECTOR/FIT TT([I1]:[I2])  _HT2([I1]:[I2])     _SHT2([I1]:[I2]) EXP2 S 2 EPAR
    CALL  GETFITPAR
    VE/INP  HTSLOP([I])  $EVAL(PAR(2)) 
    VE/INP  HTNORM([I])  $EVAL(PAR(1)) 
    VE/INP SHTSLOP([I]) $EVAL(SPAR(2)) 
    VE/INP SHTNORM([I]) $EVAL(SPAR(1)) 
*WAIT J=[J]_I=[I]
ENDDO
exe close_ps


IF [DAT]='pi0' THEN
  MA1=5; MA2=500; MA3=8; MA4=20000
ELSE
  MA1=10; MA2=350; MA3=6; MA4=3000
ENDIF
zone 2 1
OPT LINY
EXEC OPEN_PS [DAT]_ht_et_slope_all.ps
SET PMCI 2
NULL  0.1 0.5   0 [MA3]
HPLOT/ERR XBI  HTSLOP ZZ SHTSLOP 18 20 0.4
VE/fit  XBI  HTSLOP  SHTSLOP  SLOPX S 2 PSLOP

NULL  0.1 0.5   0 [MA3]
HPLOT/ERR XBI  ETSLOP ZZ SETSLOP 18 20 0.4
VE/fit  XBI  ETSLOP  SETSLOP  SLOPX S 2 PSLOP
*VE/fit  XBI    ETSLOP  SETSLOP p0 S
EXEC close_ps

EXEC OPEN_PS [DAT]_HT_slope_norm.ps
OPT LINY
TITLE 'HT'
ZONE 2 2
SET PMCI 2
NULL  0.1 0.5   0 [MA1]
HPLOT/ERR XBI  HTSLOP ZZ SHTSLOP 18 20 0.1
VE/fit  XBI  HTSLOP  SHTSLOP  SLOPX S 2 PSLOP

NULL   0 4   0 [MA1]
HPLOT/ERR Q2I  HTSLOP ZZ SHTSLOP 18 20 0.1

NULL 0.1 0.5   0 [MA2]
HPLOT/ERR XBI  HTNORM ZZ SHTNORM 18 20 0.1

VE/CREATE PQ2(2) R 1 2
NULL 0 4   0 [MA2]
HPLOT/ERR Q2I  HTNORM ZZ SHTNORM 18 20 0.1
VE/fit  Q2I    HTNORM  SHTNORM Q2N S 2 PQ2

EXEC CLOSE_PS


EXEC OPEN_PS [DAT]_ET_slope_norm.ps
OPT LINY
TITLE 'ET'
ZONE 2 2

NULL  0.1 0.5   0 [MA3]
HPLOT/ERR XBI  ETSLOP ZZ SETSLOP 18 20 0.1
VE/fit  XBI  ETSLOP  SETSLOP  SLOPX S 2 PSLOP
*VE/fit  XBI    ETSLOP  SETSLOP p0 S

NULL   0 4   0 [MA3]
HPLOT/ERR Q2I  ETSLOP ZZ SETSLOP 18 20 0.1
VE/fit  Q2I  ETSLOP  SETSLOP  SLOPX S 2 PSLOP
*VE/fit  Q2I    ETSLOP  SETSLOP p0 S

NULL 0.1 0.5   0 [MA4]
HPLOT/ERR XBI  ETNORM ZZ SETNORM 18 20 0.1
VE/fit  XBI  ETNORM  SETNORM p0 S

NULL 0 4   0 [MA4]
HPLOT/ERR Q2I  ETNORM ZZ SETNORM 18 20 0.1
VE/fit  Q2I  ETNORM  SETNORM p0 S

EXEC CLOSE_PS



*-------------------------------------------------
*
*      FIT    GFF HT2 and ET2
*
*-------------------------------------------------


1DHIST 100001  'HT2' [NP] 0.5 [NP]+0.5
/HISTOGRAM/PUT_VECT/CONTENTS 100001  _HT2
/HISTOGRAM/PUT_VECT/ERRORS   100001 _SHT2

1DHIST 100002  'ET2' [NP] 0.5 [NP]+0.5
/HISTOGRAM/PUT_VECT/CONTENTS 100002  _ET2
/HISTOGRAM/PUT_VECT/ERRORS   100002 _SET2

*---------- FIT ET2

APPLICATION HMINUIT END
NAME 1 HT_NORM
NAME 2 HT_SLOPE
NAME 3 HT_SLOPLN
NAME 4 HT_Q2
NAME 5 FREE

NAME 6  ET_NORM
NAME 7  ET_SLOPE
NAME 8  ET_SLOPLN
NAME 9  ET_Q2_POWER
NAME 10 FREE

SET PRI 2
FIX 1 2 3 4 5 10          
SIM
MINI
END
*---

TITLE ET2
ZONE
OPT LINY
HI/FIT 100002  fitet.f M 10 P
MESS HI/FIT 100002  fitet.f M 10 P
WAIT
EXEC CHECKSF [DAT] 
WAIT

*---------- FIT HT2

APPLICATION HMINUIT END
NAME 1 HT_NORM
NAME 2 HT_SLOPE
NAME 3 HT_SLOPLN
NAME 4 HT_Q2
NAME 5 FREE

NAME 6  ET_NORM
NAME 7  ET_SLOPE
NAME 8  ET_SLOPLN
NAME 9  ET_Q2_POWER
NAME 10 FREE
SET PRI 2
FIX 5   6 7 8 9 10       
SIM
MINI
END
*---

TITLE HT2
ZONE
OPT LINY
HI/FIT 100001  fitht.f M 10 P
MESS HI/FIT 100001  fitht.f M 10 P
WAIT

EXEC CHECKSF [DAT] 
WAIT

EXEC CHECKGFF [DAT] 
WAIT



CALL  GETFITPAR

VE/WRITE PAR  ! ('VE/INPUT P ',10F8.4)
VE/WRITE SPAR ! ('VE/INPUT SP',10F8.4)

RETURN

*=========================== ******* =============================

MACRO CHECKSF DAT=pi0 
exe vecdel zz
ve/create zz(100)
*

EXEC OPEN_PS [DATA]_check_sf_sf.ps
OPT GRID
ZONE 2 3

IF [dat]='pi0' THEN
  EXE FIGURE XB=0.131 Q2=1.15 n=1 m=7     MINY=-400 MAXY=400
  EXE FIGURE XB=0.187 Q2=1.61 N=16 M=23   MINY=-400 MAXY=400
  EXE FIGURE XB=0.223 Q2=1.75 N=24 M=31   MINY=-400 MAXY=400
  EXE FIGURE XB=0.276 Q2=2.21 N=51 M=58   MINY=-400 MAXY=400
  EXE FIGURE XB=0.343 Q2=2.71 N=71 M=77   MINY=-400 MAXY=400
  EXE FIGURE XB=0.43  Q2=3.22 N=84 M=88   MINY=-400 MAXY=400
ELSE
  EXE FIGURE XB=0.134 Q2=1.17 n=1 m=7   k=7  MINY=-100 MAXY=200
  EXE FIGURE XB=0.187 Q2=1.62 N=15 M=19 K=5  MINY=-100 MAXY=200
  EXE FIGURE XB=0.224 Q2=1.77 N=20 M=26 K=7  MINY=-100 MAXY=200
  EXE FIGURE XB=0.276 Q2=2.24 N=35 M=40 K=6  MINY=-100 MAXY=200
  EXE FIGURE XB=0.430 Q2=3.25 N=60 M=63 K=4  MINY=-100 MAXY=200
  EXE FIGURE XB=0.377 Q2=3.77 N=66 M=68 K=3  MINY=-100 MAXY=200
ENDIF  

EXEC CLOSE_PS
RETURN

*--------------------------------------------------------------*

MACRO FIGURE XB=0.13 Q2=1.15 n=1 m=7     MINY=-400 MAXY=400
EXEC HDELET 101; EXEC HDELET 102
K=[M]-[N]+1
NULL 0 2.0 [MINY] [MAXY]; HLINE 0
FUN='TMINQ('//[Q2]//','//[XB]//')'
TMI=$CALL([FUN])
SET FCOL 2; FUN1 101[N]  XSIGMA_T(-X,[XB],[Q2],5.75) 100 [TMI] 2.0 S
SET FCOL 4; FUN1 102[N]  XSIGMA_TT(-X,[XB],[Q2],5.75) 100 [TMI] 2.0 S
SET PMCI 2; HPLOT/ERRORS tt([n]:[m]) st([n]:[m]) zz([n]:[m]) sst([n]:[m])   [k]   20 0.1 s
SET PMCI 4; HPLOT/ERRORS tt([n]:[m]) stt([n]:[m]) zz([n]:[m]) sstt([n]:[m]) [k]   20 0.1 s

NULL 0 1 0 1 SAB
TEXT 0.5 0.85 Q2=[Q2] 0.3
TEXT 0.5 0.70 xB=[XB] 0.3
ATITLE -t,GeV^2
EXE HDELET 101[N]; 
EXE HDELET 102[N]; 
RETURN

*-------------------------------------------------------------*
MACRO CHECKGFF DATA=pi0 
EXEC HDELET 101;
EXEC HDELET 102;
exe vecdel zz
ve/create zz(100)
CLOSE 0
*
EXEC OPEN_PS [DATA]_check_gff_sf.ps
OPT GRID
ZONE 2 3

IF [data]='pi0' THEN
  EXE GFF XB=0.131 Q2=1.15 n=1  m=7     MINY=1 MAXY=100
  EXE GFF XB=0.187 Q2=1.61 N=16 M=23    MINY=1 MAXY=100
  EXE GFF XB=0.223 Q2=1.75 N=24 M=31    MINY=1 MAXY=100
  EXE GFF XB=0.276 Q2=2.21 N=51 M=58    MINY=1 MAXY=100
  EXE GFF XB=0.343 Q2=2.71 N=71 M=77    MINY=1 MAXY=100
  EXE GFF XB=0.43 Q2=3.22  N=84 M=88    MINY=1 MAXY=100
ELSE
  EXE GFF XB=0.134 Q2=1.17 n=1 m=7   k=7  MINY=-100 MAXY=200
  EXE GFF XB=0.187 Q2=1.62 N=15 M=19 K=5  MINY=-100 MAXY=200
  EXE GFF XB=0.224 Q2=1.77 N=20 M=26 K=7  MINY=-100 MAXY=200
  EXE GFF XB=0.276 Q2=2.24 N=35 M=40 K=6  MINY=-100 MAXY=200
  EXE GFF XB=0.430 Q2=3.25 N=60 M=63 K=4  MINY=-100 MAXY=200
  EXE GFF XB=0.377 Q2=3.77 N=66 M=68 K=3  MINY=-100 MAXY=200
ENDIF  

EXEC CLOSE_PS
RETURN

*----------------------------------

MACRO GFF XB=0.13 Q2=1.15 n=1 m=7     MINY=-400 MAXY=400
OPT LogY; OPT NGRI
EXEC HDELET 101[N]; EXEC HDELET 102[N]
K=[M]-[N]+1
NULL 0 2.1 [MINY] [MAXY]; HLINE 0
SET FCOL 2; FUN1 101[N] ET(-X,[XB],[Q2]) 100 0 2.0 S
SET FCOL 4; FUN1 102[N] HT(-X,[XB],[Q2]) 100 0 2.0 S

EXE VECDEL _X; EXEC VECDEL _Y; EXE VECDEL _Y2; EXE VECDEL _DY2; EXE VECDEL _DY
VE/COPY     tt([n]:[m]) _x
VE/COPY   _et2([n]:[m]) _y2
VE/COPY  _set2([n]:[m]) _dy2

SIGMA _Y=SQRT(_Y2)
SIGMA _DY=_DY2/2/_Y

SET PMCI 2
HPLOT/ERRORS _X _Y ZZ _DY   [k]   20 0.1 s

VE/COPY   _ht2([n]:[m]) _y2
VE/COPY  _sht2([n]:[m]) _dy2

SIGMA _Y=SQRT(_Y2)
SIGMA _DY=_DY2/2/_Y

SET PMCI 4
HPLOT/ERRORS _X _Y ZZ _DY   [k]   20 0.1 s
mess HPLOT/ERRORS _X _Y Z _DY   [k]   20 0.1 s

OPT LINY
NULL 0 1 0 1 SAB
TEXT 0.7 0.75 Q2=[Q2] 0.4
TEXT 0.7 0.65 xB=[XB] 0.4
ATITLE -t,GeV^2

RETURN

*---------------------------------------



